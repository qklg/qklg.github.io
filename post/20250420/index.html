
<!DOCTYPE html>
<html>
  <head>
    
<meta charset="utf-8" >

<title>哪吒改成nobody运行 | qklg</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.2/css/all.min.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://qklg.net/favicon.ico?v=1753098002439">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://qklg.net/styles/main.css">



<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.7.16/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-NG858NX84N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NG858NX84N');
</script>


  </head>
  <body>
    <div id="app" class="main">
      <div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://qklg.net">
        <img class="avatar" src="https://qklg.net/images/avatar.png?v=1753098002439" alt="" width="32px" height="32px">
      </a>
      <a href="https://qklg.net">
        <h1 class="site-title">qklg</h1>
      </a>
    </div>
    <div class="right">
      <transition name="fade">
        <i class="icon" :class="{ 'icon-close-outline': menuVisible, 'icon-menu-outline': !menuVisible }" @click="menuVisible = !menuVisible"></i>
      </transition>
    </div>
  </div>
</div>

<transition name="fade">
  <div class="menu-container" style="display: none;" v-show="menuVisible">
    <div class="menu-list">
      
        
          <a href="/" class="menu purple-link">
            首页
          </a>
        
      
        
          <a href="/archives" class="menu purple-link">
            归档
          </a>
        
      
        
          <a href="/tags" class="menu purple-link">
            标签
          </a>
        
      
        
          <a href="/post/about" class="menu purple-link">
            关于
          </a>
        
      
        
          <a href="https://cse.google.com/cse?cx=e12eaeb91706d48bf" class="menu purple-link">
            搜索
          </a>
        
      
    </div>
  </div>
</transition>


      <div class="content-container">
        <div class="post-detail">
          
          <h2 class="post-title">哪吒改成nobody运行</h2>
          <div class="post-info post-detail-info">
            <span><i class="icon-calendar-outline"></i> 2025-04-20</span>
            
          </div>
          <div class="post-content">
            <h1 id="1-前言">1 前言</h1>
<h2 id="11什么是nobody">1.1什么是nobody？</h2>
<p>维基百科上这么说的</p>
<p>https://zh.wikipedia.org/wiki/Nobody_(%E7%94%A8%E6%88%B7%E5%90%8D)</p>
<pre><code>在许多Unix系统与类Unix系统（如Linux）中，nobody是一个没有任何权限的用户。该用户不拥有任何文件，不属于任何特权组，并且除了其他用户都具有的权限外，没有任何特殊权限。某些系统还会定义类似的用户组“nogroup”。
</code></pre>
<h2 id="12优点">1.2优点</h2>
<p>哪吒agent在系统上是以root权限运行的，权限过大，nobody无任何权限，那样子就更加安全了</p>
<h2 id="13缺点">1.3缺点</h2>
<p>我发现，用完之后ping失效了，</p>
<figure data-type="image" tabindex="1"><img src="https://s3.qklg.net/img/u4VMwHf.png" alt="" loading="lazy"></figure>
<p>不过也无所谓，我本地nas有uptime kuma的ping</p>
<figure data-type="image" tabindex="2"><img src="https://s3.qklg.net/img/oRkc8wi.png" alt="" loading="lazy"></figure>
<h1 id="2-哪吒的其他安全措施">2 哪吒的其他安全措施</h1>
<p>可以参考我的这些</p>
<h2 id="1">①</h2>
<p>tls回源，加上cloudflare隐藏ip，关闭8008端口的外部访问，把哪吒后台重定向到首页</p>
<p>可以看我这个https://qklg.net/post/20241231/</p>
<p>不过前几天cloudflare的grpc出问题了，我的解决办法可以看这个</p>
<p>https://qklg.net/post/20250415/</p>
<h2 id="2">②</h2>
<p>关闭密码登录，用github 或者谷歌登录</p>
<p>谷歌可以参考我博客的这篇 https://qklg.net/post/20250126/</p>
<p>github的话可以看官方文档</p>
<h2 id="3">③</h2>
<p>最重要的禁用webssh的话</p>
<p>/opt/nezha/agent/config.yml 下的把 disable_command_execute:改成true</p>
<p>重启下哪吒探针就ok了</p>
<h1 id="3-debian修改">3 debian修改</h1>
<p>参考https://www.nodeseek.com/post-315789-1</p>
<h2 id="1-权限修改">① 权限修改</h2>
<p>把/opt/nezha下文件夹和文件统统搞成nobody</p>
<pre><code>chown -R nobody:nogroup /opt/nezha/
</code></pre>
<p>效果如图</p>
<figure data-type="image" tabindex="3"><img src="https://s3.qklg.net/img/3J7Vr54.png" alt="" loading="lazy"></figure>
<h2 id="2-修改systemd">② 修改systemd</h2>
<p>/etc/systemd/system/nezha-agent.service</p>
<p>加入如下</p>
<pre><code>User=nobody
Group=nogroup
WorkingDirectory=/home
</code></pre>
<p>效果如图</p>
<figure data-type="image" tabindex="4"><img src="https://s3.qklg.net/img/bFfpVHA.png" alt="" loading="lazy"></figure>
<h2 id="3-重启systemctl和nezha">③  重启systemctl和nezha</h2>
<pre><code>systemctl daemon-reload
systemctl restart nezha-agent.service
</code></pre>
<h2 id="4-效果检查">④  效果检查</h2>
<pre><code>ps -ef | grep agent
</code></pre>
<figure data-type="image" tabindex="5"><img src="https://s3.qklg.net/img/FMFVraK.png" alt="" loading="lazy"></figure>
<h1 id="4-openwrt修改">4 openwrt修改</h1>
<p>openwrt的安装办法是基于官方文档的</p>
<p>官方openwrt的agent安装办法请查看文档</p>
<p>https://nezha.wiki/guide/agent.html#%E5%9C%A8-openwrt-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%AE%89%E8%A3%85-agent</p>
<h2 id="1-权限修改-2">①  权限修改</h2>
<p>openwrt的是在/etc/nezha下的</p>
<p>所以命令修改下了</p>
<pre><code>chown -R nobody:nogroup /etc/nezha/
</code></pre>
<p>效果如下</p>
<figure data-type="image" tabindex="6"><img src="https://s3.qklg.net/img/EtC4O0V.png" alt="" loading="lazy"></figure>
<h2 id="2-修改initd">② 修改init.d</h2>
<p>/etc/init.d/nezha-service</p>
<pre><code>#!/bin/sh /etc/rc.common

START=99
USE_PROCD=1

start_service() {
    procd_open_instance
    procd_set_param command /etc/nezha/nezha-agent -c /etc/nezha/config.yml
    procd_set_param user nobody
    procd_set_param group nogroup
    procd_set_param respawn
    procd_close_instance
}

stop_service() {
    killall nezha-agent
}

restart() {
    stop
    sleep 2
    start
}
</code></pre>
<h2 id="3-重启initd">③ 重启init.d</h2>
<pre><code>/etc/init.d/nezha-service enable
/etc/init.d/nezha-service restart
</code></pre>
<p>或者直接reboot重启下机子完事</p>
<h2 id="4-效果检查-2">④ 效果检查</h2>
<pre><code>ps -ef | grep agent
</code></pre>
<figure data-type="image" tabindex="7"><img src="https://s3.qklg.net/img/2FfiiLh.png" alt="" loading="lazy"></figure>
<h1 id="5-unraid修改">5 unraid修改</h1>
<p>unraid的安装办法的话基于</p>
<p>https://qklg.net/post/20241209/</p>
<h2 id="1-权限修改-3">① 权限修改</h2>
<p>我的是在/mnt/disk1/nezha 下</p>
<p>命令如下</p>
<pre><code>chown -R nobody:nogroup /mnt/disk1/nezha/
</code></pre>
<figure data-type="image" tabindex="8"><img src="https://s3.qklg.net/img/xq63SfO.png" alt="" loading="lazy"></figure>
<h2 id="2-修改脚本">② 修改脚本</h2>
<p>/boot/config/plugins/user.scripts/scripts/nezha 脚本</p>
<p>改成如下</p>
<pre><code>#!/bin/bash
su -s /bin/bash nobody -c &quot;/mnt/disk1/nezha/nezha-agent -c /mnt/disk1/nezha/config.yml&quot;
</code></pre>
<h2 id="3-重启脚本">③ 重启脚本</h2>
<p>unraid上脚本重启的话 停止之后，再重新启动即可</p>
<h2 id="4-效果检查-3">④ 效果检查</h2>
<pre><code>ps -ef | grep agent
</code></pre>
<figure data-type="image" tabindex="9"><img src="https://s3.qklg.net/img/PZvDab3.png" alt="" loading="lazy"></figure>
<p>如果还有其他的进程运行的话，root下的</p>
<p>直接kill -9 进程号就行了</p>
<p>更新的话<br>
直接手动更新<br>
debain</p>
<pre><code>systemctl stop nezha-agent
rm -f /opt/nezha/agent/nezha-agent
wget -O /tmp/nezha-agent.zip &quot;https://github.com/nezhahq/agent/releases/download/v1.12.2/nezha-agent_linux_amd64.zip&quot;
sudo unzip -o /tmp/nezha-agent.zip -d /opt/nezha/agent/
rm -f /tmp/nezha-agent.zip
chown -R nobody:nogroup /opt/nezha/
systemctl daemon-reload
systemctl restart nezha-agent.service
</code></pre>
<p>openwrt</p>
<pre><code>/etc/init.d/nezha-service stop
rm -f /etc/nezha/agent/nezha-agent
wget -O /tmp/nezha-agent.zip &quot;https://github.com/nezhahq/agent/releases/download/v1.12.2/nezha-agent_linux_amd64.zip&quot;
unzip -o /tmp/nezha-agent.zip -d /etc/nezha/
rm -f /tmp/nezha-agent.zip
chown -R nobody:nogroup /etc/nezha/
/etc/init.d/nezha-service start
/etc/init.d/nezha-service restart
</code></pre>

          </div>
        </div>

        
          <div class="next-post">
            <a class="purple-link" href="https://qklg.net/post/20250416/">
              <h3 class="post-title">
                下一篇：2025年4月15日苏州古城区一日游
              </h3>
            </a>
          </div>
          
      </div>

      

      <div class="site-footer">
  <div class="slogan"></div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
  </a><br>Powered by<a href="https://github.com/getgridea/gridea" 
target="_blank">  Gridea</a>.

Hosted on   <a href="https://pages.cloudflare.com/" target="_blank">  Cloudflare Pages | <a class="rss" href="https://qklg.net/atom.xml" target="_blank">RSS</a>
</div>


    </div>
    <script type="application/javascript">

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
